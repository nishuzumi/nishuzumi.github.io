---
title: Web缓存
date: 2020-11-18 17:16:05
tags:
---
## 前言 🎤
Web中的缓存包含多个方面，从服务端的缓存机制到客户端的缓存机制，缺一不可，并且缓存在用户体验方面非常重要，本文将会记录和补充Web中的各种缓存内容。
本文主要以MDN为基础，进行其他的细节补充。
<!--more-->

## 缓存的目标
一般情况下，HTTP缓存并不是必选项，但是为了减少请求的发送数量，重用缓存内容，这项工作通常还是必要的。通常情况下HTTP缓存只能缓存`GET`请求,其他类型来说就显得无力。当然，200，301，404，206等情况，都会进行缓存。

## 缓存控制

### Cache-control
`Cache-control`是一个HTTP头部中的控制字段。它用于告诉浏览器一些数据缓存要怎么处理。

#### no-store （不储存）
不保存任何内容，每次请求都会完全下载

#### no-cache （看着存）
当`Cache-Control:no-cache`时，客户端会生成本地资源的相关验证字段，然后和服务器进行验证。如果没有变动或者没有过期，则返回`304`，浏览器因此会使用本地缓存。

#### private和public （给不给中间人存）
当为`public`时，则表示可以被中间人缓存，比如代理，CDN等等。如果指定了public，那么将会缓存一切能缓存的内容。  
默认值为`private`，这就只会缓存在浏览器之中。

#### max-age (过期)
和`Expires`不同的是，`max-age`表示的是，从请求发起时开始，将会有多久的有效时间。  
比如
```
Cache-Control: max-age=200000
```
#### must-revalidate （需要重新验证）
当有这个标示时，会告诉浏览器缓存或者缓存服务器，当过期时，一定要[缓存校验](#缓存校验)，不得使用过期资源。

## 处理机制
一个缓存理论上来说可以永久的存在缓存之中，但是如果空间不足，则会尝试驱逐一些缓存。不过要注意的是**缓存并不是到期后就立刻删除**。当一个资源过期时，缓存系统会附加一个[`If-None-Match`](#If-None-Match)当请求头，如果目标服务器返回`304(Not Modified)`，那么就可以继续使用这个缓存，如果已经过期，则会返回新的内容实体。
而缓存的查找顺序为: `Cache-control: max-age=N -> Expires -> Last Modified`
值得注意的是，max-age中的单位为秒，自请求发送开始后，返回的资源生命周期就为N秒。当不存在`max-age`时，则会去寻找`Expires`并且和头部中的`Date`进行比较判断，如果前两个都没有，那么就会缓存的寿命就为`(Date - Last-Modified) * 0.1`

## 缓存校验
当用户点击刷新时的一瞬间，就会开始缓存验证。如果响应头中含有`Cache-control: must-revalidate`，那么在浏览的过程中也会触发验证。  
当资源过期后，只有在浏览器返回强校验器或者弱校验器才会进行验证。

### ETags
`Etags`是缓存强校验器的一种，如果响应头中含有`ETags`，那么客户端可以在后续请求头中带上`If-None-Match`（值为ETags值）来验证缓存。当不匹配时，返回新的资源实体，当匹配时，返回304.
### Last-Modified
`Last-Modified`则是一种弱校验器，如果请求中含有`Last-Modified`，那么客户端后续可以带上`If-Modified-Since`来验证缓存。当缓存可以继续使用时返回304，需要更新时返回200并且更新结果。

### If-None-Match
`If-None-Match`的值一般是Etags的值，用于和服务器校验是否资源产生替换。如果没有变更，则返回304，否则200。某种情况下如果能引发服务端的状态变化，则会返回412.值得注意的是，`If-None-Match`比`If-Modified-Since `优先级更高。  
如果使用其他方法，比如`PUT`,则会有其他用途，这里不进行展开。
### If-Modified-Since 
它的效果和`If-None-Match`差别不大，最大的差异在于参数内容，该首部只允许传递时间字符串，比如`Wed, 21 Oct 2015 07:28:00 GMT`。同时它也不能用于Put。常见的场景是用于更新没有ETag的缓存实体。

## Vary 响应
Vary是一个很有意思的首部。它可以使某些首部的内容作为缓存标示。比如，`Vary: User-Agent`，这样缓存服务器就会将`User-Agent的值`作为一个缓存标识。当`User-Agent的值`与之前请求不同时，则会进行资源的重新获取。  
{% img /images/cache-2020-11-18-19-13-05.png %}