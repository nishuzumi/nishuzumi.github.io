---
title: 'â™»ï¸Eventloop,â±ï¸Timeout,âš¡ï¸Immediate,â­•ï¸Interval,ğŸ§¾QueueMicrotask'
date: 2020-11-10 14:08:58
tags:
catagories:
- [JS]
- [å‰ç«¯]
- [All In Code]
---
## å‰è¨€ ğŸ¤

æœ¬æ–‡çš„ç›®çš„åœ¨äºï¼Œä¸€æ¬¡æ€§æ¨ç¿»80%äººæ„å»ºå¥½çš„å…³äºEvent Loopçš„çŸ¥è¯†ä½“ç³»å’Œä¸€æ¬¡æ€§çš„å®Œæ•´çš„ç†è§£Nodejs(13ä»¥ä¸Š)å’Œæµè§ˆå™¨ä¸­çš„Event Loopã€‚
<!-- more -->
## åˆ’åˆ†
é¦–å…ˆè¿›è¡Œä¸€ä¸‹åŸºç¡€æ¦‚å¿µçš„åˆ’åˆ†ã€‚
Nodeä¸‹ç‰¹æœ‰çš„
- Immediate
- process.nextTick

æµè§ˆå™¨ä¸­ç‰¹æœ‰çš„:ğŸˆšï¸

åŒæ–¹å…±æœ‰çš„ï¼š
- queueMicroTask (nodejs > v11)
- setTimeout
- setInterval

### å®ä»»åŠ¡
è¿™é‡Œè¡¥å……ä¸€ä¸‹å®ä»»åŠ¡
|#|Node|Browser|
|-|----|-------|
|setTimeout|âœ…|âœ…|
|setInterval|âœ…|âœ…|
|I/O|âœ…|âœ…|
|setImmediate|âœ…|âŒ|
|mouseover(ä¹‹ç±»çš„äº‹ä»¶)|âŒ|âœ…|
|Web APIå¤§éƒ¨åˆ†å¼‚æ­¥è¿”å›æ–¹æ³•(XHR,fetch)|âŒ|âœ…|

> é€—çŸ¥è¯†ï¼šå…¶å®setTimeoutå’ŒsetIntervalä¹Ÿå±äºWeb API

### å®ä»»åŠ¡ï¼šæ³¨æ„âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸(æµè§ˆå™¨ä¸­)
`requestAnimationFrame`å’Œ`render`ä¸ä¸ºå®ä»»åŠ¡ï¼Œä¹Ÿä¸ä¸ºå¾®ä»»åŠ¡ã€‚ä»–ä»¬ä¸¤ä¸ªçš„è§¦å‘æ—¶æœºåœ¨å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ä¹‹å¤–ã€‚
`requestAnimationFrame`çš„è§¦å‘æ—¶æœºåœ¨`render`ä¹‹å‰ã€‚è€Œ`render`çš„è§¦å‘æ—¶æœºåœ¨**æ‰€æœ‰å¾®ä»»åŠ¡å¤„ç†ç»“æŸ**ä¹‹åã€‚
ä½†æ˜¯ä»–ä»¬çš„è§¦å‘é¡ºåºä¸º`microTask->requestAnimationFrame->render`
```js
requestAnimationFrame(()=>{console.log('animation')})
queueMicrotask(()=>{console.log('micro')})

/*
micro
animation
*/
```
### å¾®ä»»åŠ¡
|#|Node|Browser|
|-|----|-------|
|Promise.then catch finally|âœ…|âœ…|
|MutationObserver|âŒ|âœ…|
|queueMicrotask|âœ…|âœ…|

### å¾®ä»»åŠ¡ï¼šæ³¨æ„âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸
**`process.nextTick`ä¸æ˜¯å¾®ä»»åŠ¡**
```js
queueMicrotask(()=>{console.log('micro')})
process.nextTick(()=>{console.log('i am not micro')})

/*
i am not micro
micro
*/
```
å¦‚æœä»¥ä¸Šä¸¤ä¸ªæ³¨æ„ï¼Œéƒ½è®©ä½ åŸæœ‰çš„çŸ¥è¯†å¤§å¦å€¾å€’ï¼Œé‚£ä¹ˆè¯·ç»§ç»­å¾€ä¸‹çœ‹ï¼Œçœ‹å®Œåä½ å°†ä¼šå¾—åˆ°ä¸€åˆ‡çš„ç­”æ¡ˆã€‚

## Nodejs
å…ˆçœ‹å®˜æ–¹å®šä¹‰
{% img /images/Eventloop-Timeout-Immediate-Interval-QueueMicrotask-2020-11-11-14-11-56.png %}

>é˜¶æ®µæ¦‚è¿°
>å®šæ—¶å™¨ï¼šæœ¬é˜¶æ®µæ‰§è¡Œå·²ç»è¢« setTimeout() å’Œ setInterval() çš„è°ƒåº¦å›è°ƒå‡½æ•°ã€‚
>å¾…å®šå›è°ƒï¼šæ‰§è¡Œå»¶è¿Ÿåˆ°ä¸‹ä¸€ä¸ªå¾ªç¯è¿­ä»£çš„ I/O å›è°ƒã€‚
>idle, prepareï¼šä»…ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ã€‚
>è½®è¯¢ï¼šæ£€ç´¢æ–°çš„ I/O äº‹ä»¶;æ‰§è¡Œä¸ I/O ç›¸å…³çš„å›è°ƒï¼ˆå‡ ä¹æ‰€æœ‰æƒ…å†µä¸‹ï¼Œé™¤äº†å…³é—­çš„å›è°ƒå‡½æ•°ï¼Œé‚£äº›ç”±è®¡æ—¶å™¨å’Œ setImmediate() è°ƒåº¦çš„ä¹‹å¤–ï¼‰ï¼Œå…¶ä½™æƒ…å†µ node å°†åœ¨é€‚å½“çš„æ—¶å€™åœ¨æ­¤é˜»å¡ã€‚
>æ£€æµ‹ï¼šsetImmediate() å›è°ƒå‡½æ•°åœ¨è¿™é‡Œæ‰§è¡Œã€‚
>å…³é—­çš„å›è°ƒå‡½æ•°ï¼šä¸€äº›å…³é—­çš„å›è°ƒå‡½æ•°ï¼Œå¦‚ï¼šsocket.on('close', ...)ã€‚
>åœ¨æ¯æ¬¡è¿è¡Œçš„äº‹ä»¶å¾ªç¯ä¹‹é—´ï¼ŒNode.js æ£€æŸ¥å®ƒæ˜¯å¦åœ¨ç­‰å¾…ä»»ä½•å¼‚æ­¥ I/O æˆ–è®¡æ—¶å™¨ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™å®Œå…¨å…³é—­ã€‚

ç®€å•æ¥è¯´å°±æ˜¯æˆ‘éƒ½ä¸çŸ¥é“ä»–åœ¨è¯´ä»€ä¹ˆï¼ŒğŸ˜„ã€‚
æ‰€ä»¥æˆ‘ç‰¹æ„æ‰¾äº†ä¸€å¼ æ¯”è¾ƒå®¹æ˜“çœ‹æ‡‚çš„å›¾ï¼Œæ¥ç®€å•çš„æ¦‚æ‹¬ä¸€ä¸‹è¿™äº›å­¦æœ¯è¯­è¨€ã€‚
{% img /images/Eventloop-Timeout-Immediate-Interval-QueueMicrotask-2020-11-11-13-00-10.png %}
å›¾ç‰‡æ¥è‡ªäº’è”ç½‘

ç»†å¿ƒçš„åŒå­¦å·²ç»çœ‹å‡ºæ¥äº†ï¼Œåœ¨å›¾ç‰‡çš„ä¸­é—´çš„çº¢è‰²åŒºåŸŸå†™ç€`process.nextTick`å’Œ`microTasks`ã€‚
### ç¬¬ä¸€ä¸ªé‡ç‚¹
**åœ¨Nodeä¸­ï¼ŒnextTickå’ŒmicroTaskä¼šåœ¨æ¯ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œç»“æŸåè¢«ç«‹åˆ»æ‰§è¡Œã€‚**ã€‚
> ä»–ä»¬ä¸å±äºä»»ä½•é˜¶æ®µï¼Œä½†æ˜¯ä»–ä»¬åˆå±äºä»»ä½•é˜¶æ®µ â€”â€”Box

ç®€å•çš„æ¥è¯´ï¼Œåœ¨Nodeä¸­ï¼Œæ¯ä¸€ä¸ªå¤„ç†é˜¶æ®µç»“æŸï¼Œéƒ½ä¼šæ‰§è¡Œå¹¶æ¸…ç©º`nextTick`å’Œ`microTask`çš„ä»»åŠ¡ã€‚
è€ŒNodeä¸­ï¼Œåˆ†ä¸ºå››ä¸ªé˜¶æ®µ
- setTimeoutå’ŒsetIntervalçš„åˆ°æœŸå›è°ƒæ‰§è¡Œé˜¶æ®µ
- IOè½®è¯¢é˜¶æ®µ
- å¤„ç†setImmediateçš„å›è°ƒé˜¶æ®µ
- å¤„ç†æŸäº›å…³é—­å¥æŸ„çš„å›æ‰é˜¶æ®µ
åå¤æ‰§è¡Œã€‚
æ‰€ä»¥è¯´ï¼Œåœ¨è¿™ä¸ªå››ä¸ªé˜¶æ®µæ‰§è¡Œé—´éš”ä¸­ï¼Œåªè¦å‡ºç°äº†ä»»ä½•`nextTick`æˆ–è€…`microTask`éƒ½ä¼šè¢«æ‰§è¡ŒçŸ¥é“æ¸…ç©º

### ç¬¬äºŒä¸ªé‡ç‚¹
å…ˆè¯´é‡ç‚¹ç„¶åçœ‹ä»£ç ï¼š**åœ¨å¤„ç†nextTickå’ŒmicroTaskæ—¶ï¼Œä¼šä¸€ç›´å¾ªç¯ç›´åˆ°ä¸¤ä¸ªä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºï¼Œå¦‚æœä½ åœ¨ä»–ä»¬çš„é€»è¾‘ä¸­å¾ªç¯åˆ›å»ºäº†æ–°çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆå°†æ— æ³•ç¦»å¼€è¿™ä¸ªé˜¶æ®µ**
```js
console.log('timeout');
if(true){ // flag 1
    process.nextTick(()=>{console.log('next timeout')})
    let loop = function(){
        process.nextTick(loop)
    }
    process.nextTick(loop)
}

if(true){ // flag 2
    queueMicrotask(()=>{
        console.log('micro')
    })
    
    let micro = ()=>{queueMicrotask(micro)}
    queueMicrotask(micro)
}

setImmediate(()=>{
    console.log('immediate')
})
```
å¯ä»¥å°è¯•æŠŠflag1æˆ–è€…flag2å¤„çš„trueæ”¹æˆfalseï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå¾ªç¯å­˜åœ¨ï¼Œé‚£ä¹ˆéƒ½æ— æ³•ç¦»å¼€è¿™ä¸ª**å°¾éƒ¨å¤„ç†é˜¶æ®µ**â€”â€”æˆ‘è‡ªå·±ç¼–çš„åè¯ã€‚
### ç¬¬ä¸‰ä¸ªé‡ç‚¹
- **æ¯ä¸ªå°¾éƒ¨å¤„ç†é˜¶æ®µä¸€å®šä¼šæ‰§è¡Œï¼Œå°±ç®—å½“å‰é˜¶æ®µä»€ä¹ˆéƒ½æ²¡åšï¼Œä½†æ˜¯ä¾ç„¶ä¼šæ‰§è¡Œ**
- **å°¾éƒ¨å¤„ç†é˜¶æ®µé¡ºåºæ˜¯nextTick->queueMicroTask ä¹Ÿå°±æ˜¯ tickTask->microTaskï¼Œå¹¶ä¸”è¿™ä¸ªé¡ºåºæ˜¯å›ºå®šçš„ï¼Œä¸å¯ä»¥ç¿»è½¬ï¼Œä¹Ÿä¸å¯ä»¥å›é€€**
```js
console.log('timeout');

queueMicrotask(()=>{
    console.log('micro')
    process.nextTick(()=>{ // åœ¨microTaskä¹‹å‰æ‰§è¡Œçš„tickTaskä¸€æ—¦æ‰§è¡Œå®Œæˆï¼Œé‚£ä¹ˆåœ¨åŒä¸€ä¸ªå°¾éƒ¨é˜¶æ®µæ˜¯ä¸ä¼šç»§ç»­è¢«æ‰§è¡Œçš„ã€‚
        console.log('next')
    })
})

setImmediate(()=>{
    console.log('immediate')
})
/**
timeout
micro
next
immediate
*/
```

### ç¬¬å››ä¸ªé‡ç‚¹
**äº‹ä»¶å¾ªç¯æœ‰ä¸€ç§ç»´æŒåœ¨pollé˜¶æ®µçš„å€¾å‘**
åœ¨pollé˜¶æ®µæ—¶ï¼Œä¼šè¿›è¡Œä¸€äº›åˆ¤å®šå¤„ç†ï¼Œæ¯”å¦‚ä¼šè¿›è¡Œè®¡ç®—ï¼Œå¤§æ¦‚ä¼šåœ¨è¿™ä¸ªé˜¶æ®µåœç•™å¤šä¹…â€”â€”ä¸€èˆ¬æ ¹æ®ä¸‹ä¸€ä¸ªè¦è¢«æ‰§è¡Œçš„`setTimeout`æˆ–è€…`setInterval`æ¥å†³å®šã€‚
ç„¶åä¼šåœ¨å¯åœç•™æ—¶é—´ä¸­è¿›è¡Œç­‰å¾…ã€‚ç›´åˆ°éœ€è¦æ‰§è¡Œ`timer`çš„æ—¶å€™æ‰ä¼šé€€å‡ºã€‚
ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾è¿›å…¥pollæ—¶ï¼Œåˆä¸€ä¸ª100msä»¥åçš„æ‰ä¼šè¢«æ‰§è¡Œçš„setTimeoutï¼Œé‚£ä¹ˆï¼Œå°±ä¼šå°è¯•åœ¨è¿™100msä¹‹ä¸­ï¼Œå°½å¯èƒ½çš„ç­‰å¾…IOäº‹ä»¶è§¦å‘ï¼Œå¹¶å¤„ç†ã€‚æ¯å½“å¤„ç†å®Œåä¾ç„¶ä¼šåˆ¤æ–­ï¼Œæ˜¯å¦éœ€è¦é€€å‡ºã€‚
æ‰€ä»¥åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒNodejséƒ½ä¼šåœ¨pollé˜¶æ®µè¿è¡Œã€‚å¹¶ä¸”ï¼Œä¼šå°è¯•æ¸…ç©ºæ‰€æœ‰è¿”å›çš„IOäº‹ä»¶çš„å›è°ƒï¼ˆè¿™ä¸ªä¸æ˜¯æ— é™åˆ¶çš„ï¼Œæœ‰ä¸€ä¸ªç¡¬æ€§é™åˆ¶ï¼‰ã€‚

ä¸æ­¤åŒæ—¶ï¼Œè¿™é‡Œæœ‰å‡ºç°æ¥ä¸ªæ–°é—®é¢˜ã€‚
> å¦‚æœå›è°ƒé˜Ÿåˆ—ä¸­æœ‰å¤§é‡çš„å›è°ƒå®Œæˆäº‹ä»¶å¹¶ä¸”ä»–ä»¬ä¼šå µå¡100msä»¥ä¸Šï¼Œé‚£ä¹ˆsetTimeout(fn,10)ä¼šæ€ä¹ˆæ ·
è¿™é‡Œå°±æ˜¯ä¸€ä¸ªå¾ˆæœ‰è¶£çš„åœ°æ–¹äº†ã€‚
```js
const fs = require('fs')
console.log('start');
let globalStart = Date.now()

function call(callback) {
    fs.readFile(__filename, callback);
}

for(let i =0;i<20;i++){
    call(()=>{
        let start = Date.now()
        while(Date.now() - start < 100){}
        console.log(`done:${i}`)
    })
}

setTimeout(()=>{
    console.log(`${Date.now()-globalStart}ms`)
    console.log('timeout')
},10)
```
è¿™æ®µä»£ç ä¸­æ¨¡æ‹Ÿäº†æ¯æ¬¡IOè°ƒç”¨è¶…è¿‡100msï¼Œå¹¶ä¸”è§¦å‘äº†20æ¬¡ï¼ŒåŒæ—¶ä¹Ÿåˆ›å»ºäº†ä¸€ä¸ªtimeoutä¸º10msçš„ä»»åŠ¡ã€‚æ„Ÿå…´è¶£çš„å¯ä»¥çŒœä¸€çŒœä»–çš„è¿è¡Œç»“æœï¼Ÿ
è¿è¡Œç»“æœ
{% img /images/Eventloop-Timeout-Immediate-Interval-QueueMicrotask-2020-11-11-15-18-42.png %}

å¾ˆæ˜æ˜¾ï¼Œåœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œè¿˜æ²¡ç­‰pollä¸­å›è°ƒå…¨éƒ¨æ‰§è¡Œå®Œæˆï¼Œå°±ç›´æ¥å¼€å§‹è¿›å…¥äº†ä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œè€Œæœ‰äº›æƒ…å†µï¼Œåˆæ˜¯æ‰§è¡Œå®Œäº†å…¨éƒ¨çš„å›è°ƒæ‰è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚ 
ä¸è¿‡è¿™é‡Œä¸æ˜¯æˆ‘ä»¬è®¨è®ºçš„é‡ç‚¹ï¼Œå› ä¸ºè¿™ä¸ªæƒ³è¯´çš„æ˜¯`pending callbacks`è¿™ä¸ªé˜¶æ®µã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰äº›`done:x`æ˜¯åœ¨å·²ç»æ‰“å°äº†timeoutä¹‹åæ‰å‡ºç°ã€‚é‚£ä¹ˆä¹Ÿå°±å¯ä»¥è¯´æ˜ï¼Œå·²ç»ä»pollé˜¶æ®µå¾ªç¯åˆ°äº†timeré˜¶æ®µï¼Œæœ€ååœ¨`pending callbacks`è§¦å‘å›è°ƒã€‚æ‰€ä»¥è¿™ä¸ªå°±æ˜¯`pending callbacks`é˜¶æ®µçš„ä½œç”¨ã€‚
æœ‰äº›äººå¯èƒ½ä¿æŒæ€€ç–‘çš„æ€åº¦ï¼Œè®¤ä¸ºå¹¶æ²¡æœ‰è¿›å…¥`pending callbacks`ï¼Œå¯èƒ½ä¹‹å‰çš„`read`äº‹ä»¶å¹¶æ²¡æœ‰è¿”å›ï¼Œæ‰€ä»¥é‡æ–°è¿›å…¥äº†pollè¿›è¡Œç­‰å¾…ã€‚æˆ‘åªèƒ½å‘Šè¯‰ä½ ï¼Œæˆ‘ç¡®å®ä¹Ÿæ— æ³•è¯æ˜ä»–ä»¬ç©¶ç«Ÿæ˜¯åœ¨`pending callbacks`è¿˜æ˜¯`poll`é˜¶æ®µè¢«æ‰§è¡Œï¼Œå¦‚æœæœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œè¿˜è¯·å¤šå¤šèµæ•™ã€‚

### ç¬¬äº”ä¸ªé‡ç‚¹
**setImmediateä¹Ÿæ²¡æœ‰é‚£ä¹ˆçš„immediate**
æ‰€æœ‰äººéƒ½çŸ¥é“`setImmediate`çš„æ‰§è¡Œä¸€èˆ¬ä¼šæ¯”`setTimeout`ä¼˜å…ˆï¼Œä½†æ˜¯å…¶å®ä»–ä»¬ä¹Ÿå­˜åœ¨ç›¸åçš„æƒ…å†µã€‚æœ‰æ—¶å€™æ˜¯`immediate`å¿«ï¼Œæœ‰æ—¶å€™æ˜¯`timeout`å¿«ï¼Œè¿™ç§æƒ…å†µåœ¨ç›´æ¥å†™å‡º
```js
setTimeout(()=>{console.log('timeout')},0)
setImmediate(()=>{console.log('immediate')})
/*
æœ‰æ—¶å€™
timeout
immediate

æœ‰æ—¶å€™
immediate
timeout
*/
```
è¿™ç§æ¯«æ— æ„ä¹‰çš„ä»£ç ä¸‹ä¼šæ›´å®¹æ˜“å‡ºç°ã€‚æ‰€ä»¥ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§æƒ…å†µï¼Ÿ
{% img /images/Eventloop-Timeout-Immediate-Interval-QueueMicrotask-2020-11-11-15-59-29.png %}
[å›¾ç‰‡æ¥æº](https://medium.com/softup-technologies/node-js-internals-event-loop-in-action-59cde8ff7e8d)
ç®€å•çš„æ¥è¯´ï¼Œåœ¨è¿›å…¥äº‹ä»¶å¾ªç¯ä¹‹å‰ï¼Œä½ åªéœ€è¦è¿›è¡Œjsä»£ç æ‰§è¡Œã€‚é‚£ä¹ˆè¿™é‡Œä¹Ÿä¼šäº§ç”Ÿè€—æ—¶ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œçš„è¿ç®—æ—¶é—´å°±å……æ»¡äº†ä¸ç¡®å®šæ€§ã€‚ä¹Ÿè®¸åœ¨è¿è¡Œ`setTimeout(fn,1)`çš„é‚£ä¸€ç¬é—´ï¼Œå½“å‰çš„mså¯èƒ½ä¸º10ï¼Œä½†æ˜¯å½“nodeæ‰§è¡Œå®Œæ‰€æœ‰ä»£ç ä¹‹åï¼Œå¯¼å…¥äº†ä¸€å¤§å †æ‚ä¸ƒæ‚å…«çš„åº“ï¼Œæ­¤æ—¶çš„mså¯èƒ½å·²ç»æˆä¸ºäº†14ï¼Œå¾ˆæ˜æ˜¾ï¼Œ`setTimeout`è¢«ä¼˜å…ˆæ‰§è¡Œã€‚é‚£ä¹ˆå¦‚æœè¯´ï¼Œå½“å‰çš„mså¯èƒ½è¿˜æ˜¯10ï¼Œé‚£ä¹ˆå°±ä¼šè·³è¿‡`timer`é˜¶æ®µï¼Œæ‰€ä»¥çœ‹èµ·æ¥å°±åƒæ˜¯`setImmediate`ä¼˜å…ˆæ‰§è¡Œã€‚é‚£ä¹ˆæœ‰äººå¯èƒ½ä¼šé—®ï¼Œä¸ºå•¥è¦`setTimeout(fn,1)`ï¼Œè€Œä¸æ˜¯`setTimeout(fn,0)`ï¼Ÿè¿™å°±æ˜¯ä¸‹ä¸€ä¸ªé‡ç‚¹ã€‚

### ç¬¬å…­ä¸ªé‡ç‚¹
**åœ¨Nodejsä¸‹ï¼Œ`setTimeout`çš„æœ€å°å»¶è¿Ÿæ•°æ˜¯1ï¼Œæœ€å¤§æ•°ä¸º2147483647ï¼Œå¦‚æœå°äºæˆ–è€…å¤§äºæœ€å¤§ï¼Œé‚£ä¹ˆéƒ½ä¼šè¢«ä¿®æ”¹ä¸º1**
è¿™é‡Œå…¶å®æ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯è¿™ä¹ˆè®¾è®¡çš„ã€‚ä¸è¿‡æœ‰è¶£çš„æ˜¯ï¼Œæœ€å°ä¸º1å…¶å®æ˜¯å‘æµè§ˆå™¨çœ‹é½è€Œè¿™ä¹ˆåšçš„ã€‚ï¼ˆæºç çš„æ³¨é‡Šä¸­æ˜¯è¿™ä¹ˆå†™çš„ğŸ˜„ï¼‰

### ç¬¬ä¸ƒä¸ªé‡ç‚¹
**Promise.thenä¸­ä½¿ç”¨çš„å¾®ä»»åŠ¡ï¼Œå’ŒmicroTaskä¸ºåŒä¸€ç­‰çº§**ï¼ˆå­˜ç–‘ï¼‰
ä¸ºä»€ä¹ˆæœ‰ä¸ªå­˜ç–‘ğŸ¤¨ï¼Œå› ä¸ºä»è¡¨ç°ä¸Šæ¥çœ‹ï¼Œæ²¡æœ‰é”™è¯¯ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰å»é˜…è¯»è¯¦ç»†çš„ä»£ç æ¥è¯æ˜å®ƒçš„ç¡®å®šæ€§ã€‚
è¿è¡Œä»£ç å¦‚ä¸‹
```js
queueMicrotask(()=>{console.log('micro')})
Promise.resolve(1).then((v)=>{
    console.log(v)
})
queueMicrotask(()=>{console.log('micro2')})
/**
micro
1
micro2
*/
```
ä½†æ˜¯ï¼Œæ ¹æ®è¿™ä¸ªç»“è®ºæ¥çœ‹ï¼Œ`Promise.then`å°±æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡ã€‚å¹¶æ²¡æœ‰é«˜äººä¸€ç­‰ã€‚
## Browser
{% img /images/Eventloop-Timeout-Immediate-Interval-QueueMicrotask-2020-11-11-16-30-53.png %}
æ˜¯ä¸æ˜¯çœ‹èµ·æ¥å’ŒNodeçš„Event loopæœ‰å¾ˆå¤§çš„ä¸åŒï¼Ÿå¦‚æœæˆ‘å‘Šè¯‰ä½ å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œä¼šä¸ä¼šæ›´å¥½ï¼Ÿ
> Browserä¸­ï¼Œå»é™¤äº†`pending callbacks`,`poll`,`check`,`close callbacks`,å¹¶å…¨éƒ¨å¡å…¥`timer`ï¼Œå¾®ä»»åŠ¡å¤„ç†æ—¶æœºä¸å˜
ä½†æ˜¯æœ‰ä¸€ç‚¹å°é—®é¢˜ï¼Œå°±æ˜¯äº‹ä»¶å¾ªç¯çš„ç»“æŸæ—¶æœºã€‚ä½†æ˜¯ç­‰ä¼šä¼šè®²ã€‚

è€Œæµè§ˆå™¨ä¸­çš„æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·ã€‚`one macroTask->all microTask->requestAnimationFrame->render`ã€‚
è€Œä¸”ï¼Œå’ŒNodeç›¸ä¼¼çš„æ˜¯ï¼Œä»–ä»¬çš„`setTimeout`æˆ–è€…`setInterval`éƒ½æ˜¯å°½å¯èƒ½çš„æ‰§è¡Œï¼ˆæ—¶é—´æ— æ³•ä¿è¯å®Œå…¨ç¬¦åˆé¢„æœŸï¼‰ã€‚
è¿˜æœ‰ä¸€ç‚¹ï¼Œé‚£å°±æ˜¯`Web API`ï¼Œåœ¨æµè§ˆå™¨ä¸­ï¼Œæ‰€æœ‰æ¶‰åŠåˆ°`Web API`çš„å†…å®¹éƒ½äº¤ç»™C++å¼•æ“è¿›è¡Œå¤„ç†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ çš„`setTimeout`åˆ°åº•é¢„è®¡æ—¶é—´äº†ï¼Œå°±ç®—ä½ çš„jså¼•æ“è¢«æŸä¸ª`while(true)`ç»™å µä½äº†ï¼Œè¿™ä¸ª`setTimeout`çš„å†…å®¹ä¾ç„¶ä¼šè¢«æ¨å…¥åˆ°ä¸€ä¸ª`TaskQueue`ä¹‹ä¸­ã€‚ç­‰å¾…ä¸‹ä¸€æ¬¡`Event Loop`çš„å–å‡ºã€‚
### é‡ç‚¹ä¸€
**åœ¨æµè§ˆå™¨ä¸­ï¼Œå¾®ä»»åŠ¡çš„æ‰§è¡Œæ—¶æœºæ˜¯åœ¨è°ƒç”¨æ ˆæ¸…ç©ºæ—¶**
**æµè§ˆå™¨ä¸­ä¸€æ¬¡æ€§åªæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡**

æµè§ˆå™¨ä¸­çš„å®ä»»åŠ¡å¤„ç†æ–¹å¼å’ŒNodeç¨å¾®æœ‰ä¸€ç‚¹ç‚¹ä¸åŒï¼ŒNodeä¼šåœ¨ä¸€ä¸ªé˜¶æ®µæŠŠæ‰€æœ‰åˆ°æœŸä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆã€‚è€Œæµè§ˆå™¨ä¸­ï¼Œæ˜¯ä¼šåœ¨æ‰§è¡Œå®Œæˆä¸€ä¸ªå®è§‚ä»»åŠ¡æ—¶æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚è€Œä¸”å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ä¼šæ”¶åˆ°ç½‘ç»œç›¸åº”æˆ–è€…å…¶ä»–ç±»å‹çš„å›æ‰ä»»åŠ¡å¹²æ‰°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå’ŒNodeä¸€æ ·ï¼Œå¦‚æœä½ åœ¨å¾®ä»»åŠ¡ä¸­æ— é™åˆ›å»ºæ–°çš„å¾®ä»»åŠ¡ï¼Œé‚£ä¹ˆä½ åŸºæœ¬å¯ä»¥å’Œè¿™ä¸ªé¡µé¢è¯´å†è§äº†ğŸ‘‹ã€‚
å¦‚æœä¸ä¿¡ï¼Œå¯ä»¥è¯•è¯•è¿™ä¸ªã€‚
```js
let call = ()=>{queueMicrotask(call)}
queueMicrotask(call)
```

### é‡ç‚¹äºŒ
**`setTimeout`çš„æœ€å°æ—¶é—´ä¸º1msï¼Œè€Œå½“åµŒå¥—ç­‰çº§è¾¾åˆ°ä¸€å®šæ—¶ï¼ˆè·Ÿéšæµè§ˆå™¨ï¼Œ3-5å±‚ï¼‰ï¼Œä¸º4ms**
```js
let startTime = Date.now()
let call = ()=>{setTimeout(call);console.log(`${Date.now() - startTime}`)}
call()
```
{% img /images/Eventloop-Timeout-Immediate-Interval-QueueMicrotask-2020-11-11-19-11-53.png %}
ä¸è¦é—®1åˆ°å“ªå»äº†ï¼Œå¦‚æœå®åœ¨ä¸æ‡‚å¯ä»¥é‡æ–°çœ‹æ–‡ç« ï¼Œè¿˜æ˜¯ä¸æ‡‚å¯ä»¥æ‚„æ‚„é—®æˆ‘ï¼Œå’±ä»¬åˆ«ä¸¢äººã€‚

### é‡ç‚¹ä¸‰

## æ€»ç»“
- process.nextTickä¸æ˜¯å¾®ä»»åŠ¡
- requestAnimationFrameä¹Ÿä¸æ˜¯å¾®ä»»åŠ¡
- Promise.thenä¸­çš„åˆ›å»ºæ–¹å¼å°±æ˜¯åˆ›å»ºå¾®ä»»åŠ¡ï¼Œå¹¶ä¸”å’ŒqueueMicrotaskåŒçº§
- setTimeout(fn,0)å¹¶ä¸æ˜¯0ï¼Œæœ€å°ä¸º1
- å¦‚æœä½ è¿˜ä¸æ‡‚ï¼Œå¯ä»¥ç›´æ¥é—®æˆ‘ï¼Œå¦‚æœä½ æœ‰æ›´å¥½çš„æƒ³æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸€èµ·æ„å»ºæ›´å¥½çš„æ–‡ç« ï¼Œå¦‚æœä½ ä¸æ‡‚è€Œä¸”ä¹Ÿä¸é—®æˆ‘ï¼Œé‚£ä¹ˆæˆ‘ç›´æ¥åˆ‡è…¹è‡ªå°½ğŸ˜­ã€‚
- æœ‰äº›å†…å®¹æˆ‘å¯èƒ½æ²¡æœ‰å†™å‡ºæ¥ï¼Œæˆ–è€…ä½ æœ‰ä»»ä½•ç–‘é—®ï¼Œæˆ‘éƒ½ä¼šè¡¥å……åœ¨æ–‡ç« ä¹‹ä¸­ã€‚
